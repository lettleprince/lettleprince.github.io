---
layout: post
title: "ARKit 初体验（一）"
description: ""
category: articles
tags: [ARKit]
comments: true
---


## ARKit 介绍

增强现实技术（[Augmented Reality](https://en.wikipedia.org/wiki/Augmented_reality)，简称 AR），是一种实时地计算摄影机影像的位置及角度并加上相应图像、视频、3D模型的技术，这种技术的目标是在屏幕上把虚拟世界套在现实世界并进行互动。

苹果在 WWDC2017 上推出了 [ARKit]((https://www.youtube.com/watch?v=S14AVwaBF-Y))，从而能够让我们更方便的实现 AR 功能。

需要注意的是：

Xcode 运行 ARKit 需要 iOS11+ 的系统，而且，硬件也有要求，设备需要具备 A9 及以上处理器（也就是 iPhone SE、iPhone6S、iPhone 6S Plus之后的设备，或 2017 年之后的 iPad）。另外，还需要 XCode 9。

## 创建项目

新建 XCode 项目，选择 AR App。

![01](https://lettleprince.github.io/images/20171204-arkit-01/01.png)

填写完项目信息后，确认 Content Technology 的选项为 `Scene Kit`。[SceneKit](https://developer.apple.com/scenekit/) 框架可以在 iOS 设备上渲染 3D 图形，为 ARKit 提供了渲染 3D 内容的功能。Sprite Kit 是用来渲染 2D 图像的。

![02](https://lettleprince.github.io/images/20171204-arkit-01/02.png)

编译运行项目，移动后会申请相机权限，同意后，便可以在屏幕中看到一架飞机。是不是很简单？作为 iOS 开发者有时也会感觉到很幸福（我肯定是忘了适配 iPhone X 的痛了）。

![03](https://lettleprince.github.io/images/20171204-arkit-01/03.png)

这是苹果自带的示例程序，我们需要一步步创建自己的 Demo。

## ARKit 核心类

[`ARSCNView`](https://developer.apple.com/documentation/arkit/arscnview)：辅助视图，主要功能是将 SceneKit 渲染的 3D 内容渲染到相机的实时图像上，从而实现 AR 体验的视图。这个类主要做了以下的事情：

- 从设备相机中取到实时的画面，并渲染到 3D 场景中作为背景。

- ARKit 的三维坐标系可以与 SceneKit 的三维坐标系进行匹配。因此，在这个视图中渲染出的对象能够自动匹配到 ARKit 的世界坐标。

- 自动移动虚拟的 SceneKit 相机去匹配在真实世界中的由 ARKit 跟踪的 3D 坐标，因此我们不需要写代码来将移动事件与 SceneKit 的 3D 图像进行关联。

由于 ARKit 会自动将 SceneKit 空间与真实世界相匹配，所以要放置一个虚拟物品让它显示在真实世界的位置上，只需要给它设置一个合适的 SceneKit 坐标即可。我们并不需要使用 ARAnchor 类去追踪你添加在场景中的物体的坐标，但是还是需要实现 ARSCNViewDelegate 中的方法，这样才可以在 ARKit 自动检测的任何一个锚点上添加 SceneKit 的内容。

[`ARSession`](https://developer.apple.com/documentation/arkit/arsession)：每个用 ARKit 建立的 AR 场景都需要一个 ARSession 对象。它负责控制相机，从设备中收集所有的传感器数据（包括从设备的运动传感器中读取数据，控制设备的相机，对相机中捕获到的图像进行分析），来建立用户所在的现实世界与 AR 模型的内容空间之间的联系。ARSCNView 实例已经包含一个 ARSession 实例，只需要在启动的时候进行配置（`ARSessionConfiguration` 或其子类 `ARWorldTrackingSessionConfiguration`）就可以了。

[`ARWorldTrackingSessionConfiguration `](https://developer.apple.com/documentation/arkit/arworldtrackingsessionconfiguration)：这个类可以在 6 个自由维度上(six degrees of freedom, 6DOF)追踪设备的移动, 也就是 3 个旋转轴（roll：绕着垂直于手机屏幕的轴旋转，yaw：绕着手机的向上方向旋转，pitch：改变手机的俯仰），3 个平移轴（在 x, y, z 上的移动）。这样我们可以围绕虚拟物体进行查看，设置可以移动虚拟物体。如果没有这样的需求，并且用户并不会在虚拟体验中改变位置，那可以使用 ARSessionConfiguration 来初始化 ARSession 实例。

现阶段的项目中暂时只用到上述几个类。可以看到 ARSession 在 `viewWillAppear` 方法中被实例化。

```
- (void)viewWillAppear:(BOOL)animated {
    [super viewWillAppear:animated];
    
    // Create a session configuration
    ARWorldTrackingConfiguration *configuration = [ARWorldTrackingConfiguration new];

    // Run the view's session
    [self.sceneView.session runWithConfiguration:configuration];
}
```

## 绘制方块

接下来使用 SceneKit 绘制一个 3D 立方体。SceneKit 是所有 3D 内容的容器，它可以将多个 3D 物体以不同的位置，角度，尺寸等添加到场景中。

所要要在虚拟场景中添加内容，就要先创建一个几何体，然后将几何图形包装到场景节点中并将其添加到场景中。在 `viewDidLoad` 中添加以下代码（之前的示例代码删除）：

```
- (void)viewDidLoad {
    [super viewDidLoad];
    // Container to hold all of the 3D geometry
    SCNScene *scene = [SCNScene new];
    // The 3D cube geometry we want to draw
    SCNBox *boxGeometry = [SCNBox
                           boxWithWidth:0.1
                           height:0.1
                           length:0.1
                           chamferRadius:0.0];
    // The node that wraps the geometry so we can add it to the scene
    SCNNode *boxNode = [SCNNode nodeWithGeometry:boxGeometry];
    // Position the box just in front of the camera
    boxNode.position = SCNVector3Make(0, 0, -0.5);
    // rootNode is a special node, it is the starting point of all
    // the items in the 3D scene
    [scene.rootNode addChildNode: boxNode];
    // Set the scene to the view
    self.sceneView.scene = scene;
}
```

ARKit 中的坐标基本能用“米”对应，所以，上面的代码创建了一个 `10*10*10` 的立方体。

ARKit 和 SceneKit 的坐标系如下所示：

![04](https://lettleprince.github.io/images/20171204-arkit-01/04.png)

相机朝向的是 Z 轴的负方向，所以，是防止的 -0.5 的位置。

当 ARSession 启动时，计算出的摄像机位置初始设置为 X = 0，Y = 0，Z = 0。

现在运行项目，应该能看到漂浮在空中的立方体。

![05](https://lettleprince.github.io/images/20171204-arkit-01/05.png)

但是立方体的棱角并不是太明显，因为没有添加光照效果。添加下面的代码：

```
self.sceneView.autoenablesDefaultLighting = YES;
```

![06](https://lettleprince.github.io/images/20171204-arkit-01/06.png)


OK，这样就很容易识别出立方体了。

### 参考：

[Apple ARKit by Example](https://blog.markdaws.net/arkit-by-example-part1-7830677ef84d)


### 代码：
文章中的代码都可以从我的GitHub [`ARKitDemo`](https://github.com/lettleprince/ARKitDemo)找到。

